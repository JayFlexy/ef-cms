const {
  getCreateACaseButton,
  navigateTo: navigateToDocumentQC,
} = require('../support/pages/document-qc');

const {
  fillInCreateCaseFromPaperForm,
} = require('../support/pages/create-paper-petition');

const {
  NOTICE_OF_ATTACHMENTS_IN_NATURE_OF_EVIDENCE,
} = require('../../shared/src/business/entities/EntityConstants');

const createCaseWithAutoGeneratedNANE = () => {
  navigateToDocumentQC('petitionsclerk');
  getCreateACaseButton().click();

  const submitAfterCaseReview = () =>
    cy.get('#submit-case').scrollIntoView().click();

  const confirmSubmissionOfCase = () => cy.get('#confirm').click();
  const visitCaseDetailPage = docketNumber =>
    cy.visit(`/case-detail/${docketNumber}`);
  const confirmViewingOfCaseReciept = () =>
    cy.get('#done-viewing-paper-petition-receipt-button').click();

  fillInCreateCaseFromPaperForm();

  cy.intercept('POST', '**/paper').as('postPaperCase');
  cy.get('#submit-case').click();
  cy.wait('@postPaperCase').then(({ response }) => {
    console.log('response.body', response.body);
    const { docketNumber } = response.body;
    cy.get('#orders-notices-auto-created-in-draft').should('exist');
    submitAfterCaseReview();
    confirmSubmissionOfCase();
    confirmViewingOfCaseReciept();
    visitCaseDetailPage(docketNumber);
  });

  cy.get('#tab-drafts').click();
};

exports.createCaseWithAutoGeneratedNANE = createCaseWithAutoGeneratedNANE;

describe('Verify functionality and expected behaviour of autogenerated Order/Notice after serving a case', () => {
  let orderNoticeTitle = NOTICE_OF_ATTACHMENTS_IN_NATURE_OF_EVIDENCE.title;
  let orderNoticeEditorBodyText =
    NOTICE_OF_ATTACHMENTS_IN_NATURE_OF_EVIDENCE.content;

  describe('Verify functionality of Draft Tab Icon and the View Full PDF and Add Docket Entry buttons', () => {
    before(() => {
      createCaseWithAutoGeneratedNANE();
    });

    it('should check that the Draft Tab Icon exists with a count of 1 and the first item in the draft tab is a NANE', () => {
      cy.get('.icon-tab-unread-messages-count').should('have.text', '1');
      cy.get('.document-viewer--documents-list')
        .children()
        .should('have.length', 1);
      cy.get('#docket-entry-description-0').should(
        'have.text',
        'Notice of Attachments in the Nature of Evidence',
      );
      cy.get('.document-viewer--documents-list')
        .children()
        .should('have.length', 1);
      cy.get('#docket-entry-description-0').should(
        'have.text',
        'Notice of Attachments in the Nature of Evidence',
      );
    });

    it('should check that the View Full PDF button works with an autogenerated Notice/Order', () => {
      cy.intercept('GET', '**/document-download-url').as('viewFullPdf');
      cy.get('button#view-full-pdf').click();
      cy.wait('@viewFullPdf').then(({ response }) => {
        const { url } = response.body;
        cy.request(url).its('status').should('eq', 200);
      });
    });

    it('should check that the Add Docket Entry button works with an autogenerated Notice/Order', () => {
      cy.get('a#add-court-issued-docket-entry-button').click();
      cy.get('div.select-react-element__single-value').should(
        'have.text',
        'Notice',
      );
      cy.get('input#free-text').should('have.value', orderNoticeTitle);
      cy.get('button#serve-to-parties-btn').click();
      cy.get('button.modal-button-confirm ').click();
      cy.get('button#print-paper-service-done-button').click();
    });
  });

  describe('Verify functionality of Edit and the Delete buttons', () => {
    before(() => {
      createCaseWithAutoGeneratedNANE();
    });

    it('should check that the Edit button works with an autogenerated Notice/Order', () => {
      cy.get('#draft-edit-button-not-signed').click();
      cy.get('h1#page-title').contains(`Edit ${orderNoticeTitle}`);
      cy.get('div.ql-editor p').should('have.text', orderNoticeEditorBodyText);
      cy.get('button#cancel-order').click();
      cy.get('button.modal-button-confirm').click();
    });

    it('should check that the Delete button works with an autogenerated Notice/Order', () => {
      cy.get('#tab-drafts').click();
      cy.get('button#delete-pdf').click();
      cy.get('button.modal-button-confirm').click();

      cy.get('.icon-tab-unread-messages-count').should('not.exist');

      cy.get('section#case-detail-internal p')
        .first()
        .contains('Document deleted.')
        .should('exist');
      cy.get('section#case-detail-internal p')
        .last()
        .contains('There are no draft documents.')
        .should('exist');
    });
  });
});
